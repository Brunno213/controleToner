<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-analytics.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBSAMAhiEbBPCNqNpv-dM64Pa_xclwqc54",
    authDomain: "controletoner.firebaseapp.com",
    projectId: "controletoner",
    storageBucket: "controletoner.firebasestorage.app",
    messagingSenderId: "821741941730",
    appId: "1:821741941730:web:32bd9d82c58deef8a37fbb",
    measurementId: "G-HVQ1MN2HBD"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){ }
  const db = getFirestore(app);

  const formRegistro = document.getElementById('formRegistro');
  const escola = document.getElementById('escola');
  const modelo = document.getElementById('modelo');
  const quantidade = document.getElementById('quantidade');
  const data = document.getElementById('data');
  const tabelaRegistros = document.getElementById('tabelaRegistros');
  const filtroEscola = document.getElementById('filtroEscola');
  const filtroMes = document.getElementById('filtroMes');
  const btnLimparFiltros = document.getElementById('btnLimparFiltros');
  const btnExportarPDF = document.getElementById('btnExportarPDF');
  const btnImprimirRelatorio = document.getElementById('btnImprimirRelatorio');

  let registros = [];
  let registrosDocs = [];
  let editandoId = null;

  function iniciarListener() {
    const q = query(collection(db, 'registros'), orderBy('data', 'desc'));
    onSnapshot(q, snapshot => {
      registros = [];
      registrosDocs = [];
      snapshot.forEach(docSnap => {
        const dataDoc = docSnap.data();
        registros.push(dataDoc);
        registrosDocs.push({ id: docSnap.id, data: dataDoc });
      });
      atualizarTabela();
      atualizarDatalists();
    });
  }

  function atualizarTabela() {
    tabelaRegistros.innerHTML = '';
    const escolaFiltro = filtroEscola.value.toLowerCase();
    const mesFiltro = filtroMes.value;

    registros
      .filter(r => {
        const escolaOk = !escolaFiltro || (r.escola && r.escola.toLowerCase().includes(escolaFiltro));
        const mesOk = !mesFiltro || (r.data && r.data.startsWith(mesFiltro));
        return escolaOk && mesOk;
      })
      .forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.escola || '')}</td>
          <td>${escapeHtml(r.modelo || '')}</td>
          <td>${escapeHtml(r.quantidade || '')}</td>
          <td>${escapeHtml(r.data || '')}</td>
          <td>
            <button data-idx="${i}" class="btn-editar">✏️</button>
            <button data-idx="${i}" class="btn-excluir">🗑️</button>
          </td>
        `;
        tabelaRegistros.appendChild(tr);
      });

    document.querySelectorAll('.btn-excluir').forEach(btn => {
      btn.addEventListener('click', async () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        const docInfo = registrosDocs[idx];
        if (!confirm('Confirma exclusão deste registro?')) return;
        await deleteDoc(doc(db, 'registros', docInfo.id));
      });
    });

    document.querySelectorAll('.btn-editar').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        const docInfo = registrosDocs[idx];
        editandoId = docInfo.id;
        escola.value = docInfo.data.escola;
        modelo.value = docInfo.data.modelo;
        quantidade.value = docInfo.data.quantidade;
        data.value = docInfo.data.data;
        formRegistro.querySelector('button[type="submit"]').textContent = 'Salvar Alterações';
      });
    });
  }

  formRegistro.addEventListener('submit', async e => {
    e.preventDefault();
    const novo = {
      escola: escola.value.trim(),
      modelo: modelo.value.trim(),
      quantidade: quantidade.value,
      data: data.value
    };

    if (!novo.escola || !novo.modelo || !novo.quantidade || !novo.data) {
      alert('Preencha todos os campos.');
      return;
    }

    try {
      if (editandoId) {
        const ref = doc(db, 'registros', editandoId);
        await updateDoc(ref, novo);
        editandoId = null;
        formRegistro.querySelector('button[type="submit"]').textContent = 'Registrar';
      } else {
        await addDoc(collection(db, 'registros'), novo);
      }
      formRegistro.reset();
    } catch (err) {
      console.error('Erro ao salvar:', err);
      alert('Erro ao registrar ou atualizar o dado.');
    }
  });

  function atualizarDatalists() {
    const listaEscolas = document.getElementById('listaEscolas');
    const listaModelos = document.getElementById('listaModelos');
    listaEscolas.innerHTML = '';
    listaModelos.innerHTML = '';

    const escolasSet = new Set(registros.map(r => r.escola).filter(Boolean));
    const modelosSet = new Set(registros.map(r => r.modelo).filter(Boolean));

    escolasSet.forEach(e => listaEscolas.appendChild(new Option(e)));
    modelosSet.forEach(m => listaModelos.appendChild(new Option(m)));
  }

  filtroEscola.addEventListener('input', atualizarTabela);
  filtroMes.addEventListener('input', atualizarTabela);
  btnLimparFiltros.addEventListener('click', () => {
    filtroEscola.value = '';
    filtroMes.value = '';
    atualizarTabela();
  });

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
  }

  iniciarListener();
</script>
