<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Controle de Troca de Toner e Tinta</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px; }
  .container { max-width:900px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,0.1); }
  h2 { text-align:center; color:#444; }
  form { display:grid; gap:10px; margin-bottom:20px; }
  label { font-weight:bold; }
  input, select, button { padding:8px; font-size:14px; border-radius:5px; border:1px solid #ccc; }
  button { cursor:pointer; background:#40739e; color:white; border:none; }
  button:hover { background:#2f5d83; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#40739e; color:white; }
  #filtros { display:flex; gap:10px; margin-top:20px; align-items:center; flex-wrap:wrap; }
  #btnLimparFiltros { background:#999; }
  #btnLimparFiltros:hover { background:#777; }
</style>
</head>
<body>
<div class="container">
  <h2>Controle de Trocas de Toner e Tinta</h2>

  <form id="formRegistro">
    <label>Nome da Escola:</label>
    <input list="listaEscolas" id="escola" required>
    <datalist id="listaEscolas"></datalist>

    <label>Modelo do Toner/Tinta:</label>
    <input list="listaModelos" id="modelo" required>
    <datalist id="listaModelos"></datalist>

    <label>Quantidade:</label>
    <input type="number" id="quantidade" min="1" required>

    <label>Data da Troca:</label>
    <input type="date" id="data" required>

    <button type="submit" id="btnSalvar">Registrar</button>
    <button type="button" id="btnCancelarEdicao" style="display:none; background:#999;">Cancelar Edi√ß√£o</button>
  </form>

  <div id="filtros">
    <input type="text" id="filtroEscola" placeholder="Filtrar por escola...">
    <input type="month" id="filtroMes">
    <button id="btnLimparFiltros">Limpar Filtros</button>
    <button id="btnExportarPDF">Exportar PDF</button>
    <button id="btnImprimirRelatorio">Imprimir Relat√≥rio</button>
    <button id="btnEditarListas" style="background:#6c5ce7;">Editar Escolas/Modelos</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Escola</th>
        <th>Modelo</th>
        <th>Quantidade</th>
        <th>Data</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabelaRegistros"></tbody>
  </table>
</div>

<!-- Firebase modular SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBSAMAhiEbBPCNqNpv-dM64Pa_xclwqc54",
    authDomain: "controletoner.firebaseapp.com",
    projectId: "controletoner",
    storageBucket: "controletoner.firebasestorage.app",
    messagingSenderId: "821741941730",
    appId: "1:821741941730:web:32bd9d82c58deef8a37fbb",
    measurementId: "G-HVQ1MN2HBD"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const formRegistro = document.getElementById('formRegistro');
  const escola = document.getElementById('escola');
  const modelo = document.getElementById('modelo');
  const quantidade = document.getElementById('quantidade');
  const data = document.getElementById('data');
  const tabelaRegistros = document.getElementById('tabelaRegistros');
  const filtroEscola = document.getElementById('filtroEscola');
  const filtroMes = document.getElementById('filtroMes');
  const btnLimparFiltros = document.getElementById('btnLimparFiltros');
  const btnExportarPDF = document.getElementById('btnExportarPDF');
  const btnImprimirRelatorio = document.getElementById('btnImprimirRelatorio');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');
  const btnEditarListas = document.getElementById('btnEditarListas');

  let registros = [];
  let registrosDocs = [];
  let idEmEdicao = null;

  function iniciarListener() {
    const q = query(collection(db, 'registros'), orderBy('data', 'desc'));
    onSnapshot(q, snapshot => {
      registros = [];
      registrosDocs = [];
      snapshot.forEach(docSnap => {
        const dataDoc = docSnap.data();
        registros.push(dataDoc);
        registrosDocs.push({ id: docSnap.id, data: dataDoc });
      });
      atualizarTabela();
      atualizarDatalists();
    }, err => {
      console.error('Erro no listener do Firestore:', err);
    });
  }

  function atualizarTabela() {
    tabelaRegistros.innerHTML = '';
    const escolaFiltro = filtroEscola.value.toLowerCase();
    const mesFiltro = filtroMes.value;

    registros
      .filter(r=>{
        const escolaOk = !escolaFiltro || (r.escola && r.escola.toLowerCase().includes(escolaFiltro));
        const mesOk = !mesFiltro || (r.data && r.data.startsWith(mesFiltro));
        return escolaOk && mesOk;
      })
      .forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.escola || '')}</td>
          <td>${escapeHtml(r.modelo || '')}</td>
          <td>${escapeHtml(r.quantidade || '')}</td>
          <td>${escapeHtml(r.data || '')}</td>
          <td>
            <button data-idx="${i}" class="btn-editar">‚úèÔ∏è</button>
            <button data-idx="${i}" class="btn-excluir">üóëÔ∏è</button>
          </td>
        `;
        tabelaRegistros.appendChild(tr);
      });

    // adiciona listeners depois de renderizar
    document.querySelectorAll('.btn-excluir').forEach(btn=>{
      btn.addEventListener('click', async ()=> {
        const idx = parseInt(btn.getAttribute('data-idx'));
        const docInfo = registrosDocs[idx];
        if(!docInfo) return alert('Registro n√£o encontrado.');
        if(!confirm('Confirma exclus√£o deste registro?')) return;
        try {
          await deleteDoc(doc(db, 'registros', docInfo.id));
        } catch(err) {
          console.error('Erro ao excluir:', err);
          alert('Erro ao excluir registro.');
        }
      });
    });

    document.querySelectorAll('.btn-editar').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const idx = parseInt(btn.getAttribute('data-idx'));
        const docInfo = registrosDocs[idx];
        if(!docInfo) return alert('Registro n√£o encontrado.');
        idEmEdicao = docInfo.id;
        escola.value = docInfo.data.escola || '';
        modelo.value = docInfo.data.modelo || '';
        quantidade.value = docInfo.data.quantidade || '';
        data.value = docInfo.data.data || '';
        btnSalvar.textContent = "Salvar Altera√ß√µes";
        btnCancelarEdicao.style.display = "inline-block";
      });
    });
  }

  formRegistro.addEventListener('submit', async e=>{
    e.preventDefault();
    const novo = {
      escola: escola.value.trim(),
      modelo: modelo.value.trim(),
      quantidade: quantidade.value,
      data: data.value
    };
    if(!novo.escola || !novo.modelo || !novo.quantidade || !novo.data){
      alert('Preencha todos os campos.');
      return;
    }

    try{
      if(idEmEdicao){
        await updateDoc(doc(db, 'registros', idEmEdicao), novo);
        idEmEdicao = null;
        btnSalvar.textContent = "Registrar";
        btnCancelarEdicao.style.display = "none";
      } else {
        await addDoc(collection(db, 'registros'), novo);
      }
      formRegistro.reset();
    }catch(err){
      console.error('Erro ao salvar:', err);
      alert('Erro ao salvar os dados.');
    }
  });

  btnCancelarEdicao.addEventListener('click', ()=>{
    idEmEdicao = null;
    formRegistro.reset();
    btnSalvar.textContent = "Registrar";
    btnCancelarEdicao.style.display = "none";
  });

  function atualizarDatalists() {
    const listaEscolas = document.getElementById('listaEscolas');
    const listaModelos = document.getElementById('listaModelos');
    listaEscolas.innerHTML = '';
    listaModelos.innerHTML = '';

    const escolasSet = new Set(registros.map(r => r.escola).filter(Boolean));
    const modelosSet = new Set(registros.map(r => r.modelo).filter(Boolean));

    escolasSet.forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e;
      listaEscolas.appendChild(opt);
    });
    modelosSet.forEach(m=>{
      const opt = document.createElement('option');
      opt.value = m;
      listaModelos.appendChild(opt);
    });
  }

  btnEditarListas.addEventListener('click', async ()=>{
    const escolas = Array.from(new Set(registros.map(r=>r.escola).filter(Boolean)));
    const modelos = Array.from(new Set(registros.map(r=>r.modelo).filter(Boolean)));

    const novaEscola = prompt("Editar lista de escolas (separe por v√≠rgulas):", escolas.join(', '));
    if(novaEscola === null) return;
    const novasEscolas = novaEscola.split(',').map(e=>e.trim()).filter(Boolean);

    const novoModelo = prompt("Editar lista de modelos (separe por v√≠rgulas):", modelos.join(', '));
    if(novoModelo === null) return;
    const novosModelos = novoModelo.split(',').map(e=>e.trim()).filter(Boolean);

    const listaEscolas = document.getElementById('listaEscolas');
    const listaModelos = document.getElementById('listaModelos');
    listaEscolas.innerHTML = '';
    listaModelos.innerHTML = '';
    novasEscolas.forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e;
      listaEscolas.appendChild(opt);
    });
    novosModelos.forEach(m=>{
      const opt = document.createElement('option');
      opt.value = m;
      listaModelos.appendChild(opt);
    });
  });

  filtroEscola.addEventListener('input', atualizarTabela);
  filtroMes.addEventListener('input', atualizarTabela);
  btnLimparFiltros.addEventListener('click', ()=>{
    filtroEscola.value='';
    filtroMes.value='';
    atualizarTabela();
  });

  // ---- UNIFICADO: Exportar PDF e Imprimir Relat√≥rio ----
  function gerarDadosFiltrados() {
    const escolaFiltro = filtroEscola.value.toLowerCase();
    const mesFiltro = filtroMes.value;
    const filtrados = registros.filter(r=>{
      const escolaOk = !escolaFiltro || (r.escola && r.escola.toLowerCase().includes(escolaFiltro));
      const mesOk = !mesFiltro || (r.data && r.data.startsWith(mesFiltro));
      return escolaOk && mesOk;
    });
    return filtrados;
  }

  // Exportar PDF (com verifica√ß√£o segura do jsPDF)
  btnExportarPDF.addEventListener('click', ()=>{
    try {
      // obter construtor do jsPDF de forma tolerante
      const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF || null;
      if(!jsPDFCtor){
        alert('Biblioteca jsPDF n√£o carregada corretamente.');
        return;
      }
      const docPdf = new jsPDFCtor();
      const filtrados = gerarDadosFiltrados();
      if (filtrados.length === 0) {
        alert('N√£o h√° registros para exportar.');
        return;
      }

      let titulo = 'Relat√≥rio de Trocas de Toner e Tinta';
      const mesFiltro = filtroMes.value;
      if (mesFiltro) {
        const [ano, mesNum] = mesFiltro.split('-');
        const nomesMes = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        titulo += ` - ${nomesMes[parseInt(mesNum)-1]} de ${ano}`;
      }

      docPdf.text(titulo, 14, 15);
      docPdf.autoTable({
        startY: 25,
        head: [['Escola', 'Modelo', 'Quantidade', 'Data']],
        body: filtrados.map(r => [r.escola, r.modelo, r.quantidade, r.data]),
      });

      // posi√ß√£o segura para o texto do total
      let finalY = 40;
      if (docPdf.lastAutoTable && typeof docPdf.lastAutoTable.finalY === 'number') {
        finalY = docPdf.lastAutoTable.finalY + 10;
      } else {
        // fallback aproximado: cada linha ~8pt
        finalY = 25 + (filtrados.length + 2) * 8;
      }

      const totalGeral = filtrados.reduce((soma, r) => soma + parseInt(r.quantidade || 0), 0);
      docPdf.text(`Total geral: ${totalGeral}`, 14, finalY);

      docPdf.save('Relatorio_Toner.pdf');
    } catch (err) {
      console.error('Erro ao gerar PDF:', err);
      alert('Erro ao gerar PDF. Veja console para detalhes.');
    }
  });

  // Impress√£o
  btnImprimirRelatorio.addEventListener('click', ()=>{
    const filtrados = gerarDadosFiltrados();
    if (filtrados.length === 0) {
      alert('N√£o h√° registros para imprimir.');
      return;
    }

    const mesFiltro = filtroMes.value;
    let mesTexto = '';
    if (mesFiltro) {
      const [ano, mesNum] = mesFiltro.split('-');
      const nomesMes = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      mesTexto = `${nomesMes[parseInt(mesNum)-1]} de ${ano}`;
    }

    const totalGeral = filtrados.reduce((soma, r) => soma + parseInt(r.quantidade || 0), 0);

    let html = `
      <html>
      <head>
        <title>Relat√≥rio de Trocas de Toner e Tinta</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          h2 { text-align: center; }
          table { border-collapse: collapse; width: 100%; margin-top: 20px; }
          th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
          th { background-color: #eee; }
          tfoot td { font-weight: bold; }
          @media print {
            button { display: none; }
          }
        </style>
      </head>
      <body>
        <h2>Relat√≥rio de Trocas de Toner e Tinta</h2>
        <p><strong>Data de Emiss√£o:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
        ${mesTexto ? `<p><strong>M√™s do Relat√≥rio:</strong> ${mesTexto}</p>` : ''}
        ${filtroEscola.value ? `<p><strong>Escola:</strong> ${escapeHtml(filtroEscola.value)}</p>` : ''}

        <table>
          <thead>
            <tr>
              <th>Escola</th>
              <th>Modelo</th>
              <th>Quantidade</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody>
            ${filtrados.map(r => `
              <tr>
                <td>${escapeHtml(r.escola)}</td>
                <td>${escapeHtml(r.modelo)}</td>
                <td>${r.quantidade}</td>
                <td>${r.data}</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2">Total Geral</td>
              <td>${totalGeral}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <script>
          window.onload = function(){
            setTimeout(() => {
              window.print();
              // fecha s√≥ ap√≥s breve espera para garantir execu√ß√£o
              setTimeout(()=> window.close(), 700);
            }, 200);
          };
        </script>
      </body>
      </html>
    `;

    const novaJanela = window.open('', '_blank');
    if (!novaJanela) {
      alert('O navegador bloqueou o pop-up. Permita pop-ups para usar a impress√£o.');
      return;
    }
    novaJanela.document.open();
    novaJanela.document.write(html);
    novaJanela.document.close();
  });

  function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  iniciarListener();
</script>
</body>
</html>
